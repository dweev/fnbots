name: Node.js CI

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20, 22, 24]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install System Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y \
            build-essential pkg-config cmake python3 python3-dev \
            ffmpeg imagemagick \
            libavformat-dev libavcodec-dev libavutil-dev \
            libavfilter-dev \
            libswresample-dev libswscale-dev \
            libwebp-dev libpng-dev libjpeg-dev zlib1g-dev \
            libfreetype6-dev libharfbuzz-dev libpango1.0-dev \
            libgif-dev libopus-dev libvpx-dev \
            libcurl4-openssl-dev libnghttp2-dev libssl-dev

      - name: Install Dependencies
        run: npm ci

      - name: Audit Dependencies
        run: npm audit --audit-level=moderate || true

      - name: Check Unused Dependencies
        run: npx depcheck --ignores=node-addon-api || true

      - name: Check for Updates
        run: npx npm-check-updates || true

      - name: Run Tests
        run: |
          if [ -f "package.json" ] && grep -q "\"test\":" package.json; then
            npm test || echo "Tests failed or not implemented, skipping."
          else
            echo "No test script found, skipping tests."
          fi