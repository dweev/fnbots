name: Auto Release

on:
  push:
    branches: ["master"]

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install System Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y \
            build-essential pkg-config cmake python3 python3-dev \
            ffmpeg imagemagick \
            libavformat-dev libavcodec-dev libavutil-dev \
            libavfilter-dev \
            libswresample-dev libswscale-dev \
            libwebp-dev libpng-dev libjpeg-dev zlib1g-dev \
            libfreetype6-dev libharfbuzz-dev libpango1.0-dev \
            libgif-dev libopus-dev libvpx-dev \
            libcurl4-openssl-dev libnghttp2-dev libssl-dev

      - name: Install dependencies
        run: npm install

      - name: Check version changes
        id: check_version
        run: |
          NEW_VERSION=$(jq -r .version package.json)
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          OLD_VERSION=${LAST_TAG#v}

          if [ "$NEW_VERSION" != "$OLD_VERSION" ]; then
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "old_version=$OLD_VERSION" >> $GITHUB_OUTPUT
            echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
            
            IFS='.' read -ra NEW <<< "$NEW_VERSION"
            IFS='.' read -ra OLD <<< "$OLD_VERSION"
            
            if [ "${NEW[0]}" != "${OLD[0]}" ]; then
              echo "update_type=Major" >> $GITHUB_OUTPUT
            elif [ "${NEW[1]}" != "${OLD[1]}" ]; then
              echo "update_type=Minor" >> $GITHUB_OUTPUT
            else
              echo "update_type=Patch" >> $GITHUB_OUTPUT
            fi
          else
            echo "version_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        if: steps.check_version.outputs.version_changed == 'true'
        run: |
          bash -c 'cat > generate_changelog.sh << "SCRIPT_EOF"
          #!/bin/bash
          set -e

          echo "=== Generate Full Changelog ==="
          echo ""

          if [ -f CHANGELOG.md ]; then
            cp CHANGELOG.md CHANGELOG.md.backup
            echo "üì¶ Backed up CHANGELOG.md to CHANGELOG.md.backup"
          fi

          TAGS=($(git tag -l --sort=-version:refname))

          if [ ${#TAGS[@]} -eq 0 ]; then
            echo "‚ùå No tags found!"
            exit 1
          fi

          echo "Found ${#TAGS[@]} tags"

          declare -A SEEN_COMMITS

          echo "=== First Pass: Marking commits from oldest to newest ==="
          TAG_COUNT=${#TAGS[@]}

          for ((idx=$TAG_COUNT-1; idx>=0; idx--)); do
            CURRENT_TAG="${TAGS[$idx]}"
            
            echo "Scanning $CURRENT_TAG (index $idx)..."
            
            TEMP_FILE=`mktemp`
            
            if [ $idx -eq `expr $TAG_COUNT - 1` ]; then
              echo "  Getting all commits up to oldest tag..."
              git log ${CURRENT_TAG} --pretty=format:"%H" > "$TEMP_FILE"
            else
              PREV_TAG="${TAGS[`expr $idx + 1`]}"
              echo "  Getting commits between $PREV_TAG and $CURRENT_TAG..."
              git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"%H" > "$TEMP_FILE"
            fi
            
            while read -r HASH; do
              if [ -n "$HASH" ] && [ -z "${SEEN_COMMITS[$HASH]}" ]; then
                SEEN_COMMITS[$HASH]=$CURRENT_TAG
              fi
            done < "$TEMP_FILE"
            
            rm -f "$TEMP_FILE"
          done

          echo ""
          echo "=== Second Pass: Building changelog (newest to oldest) ==="

          echo "# Changelog" > CHANGELOG.new.md
          echo "" >> CHANGELOG.new.md
          echo "All notable changes to this project will be documented in this file." >> CHANGELOG.new.md
          echo "" >> CHANGELOG.new.md

          echo "Checking for unreleased commits..."
          LATEST_TAG="${TAGS[0]}"
          TEMP_FILE=`mktemp`
          UNRELEASED_FILE=`mktemp`
          git log ${LATEST_TAG}..HEAD --pretty=format:"%H|%s" > "$TEMP_FILE"

          UNRELEASED_COUNT=0
          while IFS="|" read -r HASH SUBJECT; do
            if [ -n "$HASH" ]; then
              SHORT_HASH=`echo $HASH | cut -c1-7`
              echo "- $SUBJECT ([$SHORT_HASH](https://github.com/${{ github.repository }}/commit/$HASH))" >> "$UNRELEASED_FILE"
              UNRELEASED_COUNT=`expr $UNRELEASED_COUNT + 1`
            fi
          done < "$TEMP_FILE"
          rm -f "$TEMP_FILE"

          if [ -s "$UNRELEASED_FILE" ]; then
            echo "## [Unreleased]" >> CHANGELOG.new.md
            echo "" >> CHANGELOG.new.md
            echo "### üöÄ What'\''s Changed" >> CHANGELOG.new.md
            cat "$UNRELEASED_FILE" >> CHANGELOG.new.md
            echo "" >> CHANGELOG.new.md
            echo "  ‚úì Found $UNRELEASED_COUNT unreleased commits"
          else
            echo "  ‚ÑπÔ∏è  No unreleased commits"
          fi
          rm -f "$UNRELEASED_FILE"

          for i in "${!TAGS[@]}"; do
            CURRENT_TAG="${TAGS[$i]}"
            NEXT_TAG=""
            if [ `expr $i + 1` -lt ${#TAGS[@]} ]; then
              NEXT_TAG="${TAGS[`expr $i + 1`]}"
            fi
            
            VERSION="${CURRENT_TAG#v}"
            TAG_DATE=`git log -1 --format=%ai $CURRENT_TAG | cut -d" " -f1`
            
            echo "Processing $CURRENT_TAG..."
            
            TEMP_FILE=`mktemp`
            UNIQUE_FILE=`mktemp`
            
            if [ -n "$NEXT_TAG" ]; then
              git log ${NEXT_TAG}..${CURRENT_TAG} --pretty=format:"%H|%s" > "$TEMP_FILE"
            else
              git log ${CURRENT_TAG} --pretty=format:"%H|%s" > "$TEMP_FILE"
            fi
            
            COMMIT_COUNT=0
            while IFS="|" read -r HASH SUBJECT; do
              if [ -n "$HASH" ] && [ "${SEEN_COMMITS[$HASH]}" = "$CURRENT_TAG" ]; then
                SHORT_HASH=`echo $HASH | cut -c1-7`
                echo "- $SUBJECT ([$SHORT_HASH](https://github.com/${{ github.repository }}/commit/$HASH))" >> "$UNIQUE_FILE"
                COMMIT_COUNT=`expr $COMMIT_COUNT + 1`
              fi
            done < "$TEMP_FILE"
            
            if [ -s "$UNIQUE_FILE" ]; then
              echo "## [$VERSION] - $TAG_DATE" >> CHANGELOG.new.md
              echo "" >> CHANGELOG.new.md
              echo "### üöÄ What'\''s Changed" >> CHANGELOG.new.md
              cat "$UNIQUE_FILE" >> CHANGELOG.new.md
              echo "" >> CHANGELOG.new.md
              echo "  ‚úì $COMMIT_COUNT unique commits"
            else
              echo "  ‚ö†Ô∏è  No unique commits for $CURRENT_TAG (all merged from older tags)"
            fi
            
            rm -f "$TEMP_FILE" "$UNIQUE_FILE"
          done

          echo ""
          echo "Total lines: `wc -l < CHANGELOG.new.md`"
          echo "Unique commits tracked: ${#SEEN_COMMITS[@]}"

          mv CHANGELOG.new.md CHANGELOG.md
          echo "‚úÖ CHANGELOG.md regenerated (deduplicated)!"
          rm -f CHANGELOG.md.backup
          SCRIPT_EOF

          chmod +x generate_changelog.sh
          ./generate_changelog.sh
          rm -f generate_changelog.sh'

      - name: Update changelog for new release
        if: steps.check_version.outputs.version_changed == 'true'
        run: |
          VERSION="${{ steps.check_version.outputs.version }}"
          TAG_DATE=$(date +%Y-%m-%d)
          
          # Replace [Unreleased] with new version
          if grep -q "## \[Unreleased\]" CHANGELOG.md; then
            sed -i "s/## \[Unreleased\]/## [$VERSION] - $TAG_DATE/" CHANGELOG.md
          fi

      - name: Generate release notes
        if: steps.check_version.outputs.version_changed == 'true'
        run: |
          VERSION="${{ steps.check_version.outputs.version }}"
          LAST_TAG="${{ steps.check_version.outputs.last_tag }}"
          
          echo "## üéâ What's Changed in v$VERSION" > release_notes.txt
          echo "" >> release_notes.txt
          
          if [ "$LAST_TAG" != "v0.0.0" ]; then
            COMMIT_COUNT=$(git log ${LAST_TAG}..HEAD --oneline --no-merges | wc -l)
            
            FEAT_COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges --grep="^feat" 2>/dev/null || echo "")
            if [ -n "$FEAT_COMMITS" ]; then
              echo "### ‚ú® Features" >> release_notes.txt
              echo "$FEAT_COMMITS" >> release_notes.txt
              echo "" >> release_notes.txt
            fi
            
            FIX_COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges --grep="^fix" 2>/dev/null || echo "")
            if [ -n "$FIX_COMMITS" ]; then
              echo "### üêõ Bug Fixes" >> release_notes.txt
              echo "$FIX_COMMITS" >> release_notes.txt
              echo "" >> release_notes.txt
            fi
            
            DOC_COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges --grep="^docs" 2>/dev/null || echo "")
            if [ -n "$DOC_COMMITS" ]; then
              echo "### üìö Documentation" >> release_notes.txt
              echo "$DOC_COMMITS" >> release_notes.txt
              echo "" >> release_notes.txt
            fi
            
            REFACTOR_COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges --grep="^chore\|^refactor" 2>/dev/null || echo "")
            if [ -n "$REFACTOR_COMMITS" ]; then
              echo "### üîß Chores & Refactoring" >> release_notes.txt
              echo "$REFACTOR_COMMITS" >> release_notes.txt
              echo "" >> release_notes.txt
            fi
            
            echo "### üìä Statistics" >> release_notes.txt
            echo "- **Total Commits**: $COMMIT_COUNT" >> release_notes.txt
            FILES_CHANGED=$(git diff --shortstat ${LAST_TAG}..HEAD 2>/dev/null | awk '{print $1}' || echo "0")
            echo "- **Files Changed**: $FILES_CHANGED" >> release_notes.txt
            echo "" >> release_notes.txt
            echo "---" >> release_notes.txt
            echo "" >> release_notes.txt
            echo "üìù **[View Full Changelog](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md)**" >> release_notes.txt
            echo "" >> release_notes.txt
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${LAST_TAG}...v${VERSION}" >> release_notes.txt
          else
            echo "### üéâ Initial Release" >> release_notes.txt
            echo "" >> release_notes.txt
            git log --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" --no-merges >> release_notes.txt
            echo "" >> release_notes.txt
            echo "---" >> release_notes.txt
            echo "" >> release_notes.txt
            echo "üìù **[View Full Changelog](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md)**" >> release_notes.txt
            echo "" >> release_notes.txt
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/commits/v${VERSION}" >> release_notes.txt
          fi

      - name: Commit changelog
        if: steps.check_version.outputs.version_changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [[ -n $(git status --porcelain CHANGELOG.md) ]]; then
            git add CHANGELOG.md
            git commit -m "chore(release): update CHANGELOG.md for v${{ steps.check_version.outputs.version }}"
            
            for i in {1..3}; do
              if git push; then
                break
              else
                sleep 5
                git pull --rebase
              fi
            done
          fi

      - name: Create GitHub Release
        if: steps.check_version.outputs.version_changed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.check_version.outputs.version }}
          name: "Release v${{ steps.check_version.outputs.version }} (${{ steps.check_version.outputs.update_type }})"
          body_path: release_notes.txt
          generate_release_notes: false
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: steps.check_version.outputs.version_changed == 'true'
        run: |
          echo "## Release v${{ steps.check_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Type**: ${{ steps.check_version.outputs.update_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Previous**: v${{ steps.check_version.outputs.old_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üîó [View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.check_version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "üìù [View Changelog](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat release_notes.txt >> $GITHUB_STEP_SUMMARY

      - name: No release summary
        if: steps.check_version.outputs.version_changed == 'false'
        run: |
          echo "## ‚ÑπÔ∏è No Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No version change detected in package.json." >> $GITHUB_STEP_SUMMARY
          echo "Current version remains at: $(jq -r .version package.json)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To create a new release, update the version in package.json." >> $GITHUB_STEP_SUMMARY